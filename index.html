<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokročilý test vibrací Xbox</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            background-color: #121212;
            color: white;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #1e1e1e;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 120, 215, 0.3);
        }
        h1 {
            color: #0078d7;
            margin-bottom: 10px;
        }
        .status-box {
            background-color: #252525;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            min-height: 80px;
            border-left: 4px solid #0078d7;
        }
        .triggers {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 30px 0;
        }
        .trigger {
            width: 120px;
            text-align: center;
        }
        .trigger-bar {
            height: 200px;
            width: 60px;
            background-color: #333;
            border-radius: 5px;
            margin: 0 auto 10px;
            position: relative;
            overflow: hidden;
        }
        .trigger-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 0%;
            background: linear-gradient(to top, #0078d7, #4cc9f0);
            transition: height 0.1s;
        }
        .vibration-display {
            width: 150px;
            height: 150px;
            margin: 30px auto;
            border-radius: 50%;
            background-color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            transition: all 0.2s;
        }
        .buttons {
            margin: 20px 0;
        }
        button {
            background-color: #0078d7;
            color: white;
            border: none;
            padding: 12px 25px;
            margin: 0 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #005a9e;
        }
        .error {
            color: #ff4444;
            margin-top: 20px;
            padding: 10px;
            background-color: #2a1a1a;
            border-radius: 5px;
            display: none;
        }
        .debug-info {
            margin-top: 30px;
            text-align: left;
            background-color: #252525;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            max-height: 150px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Pokročilý test vibrací Xbox kontroléru</h1>
        <p>Použijte spouště LT/RT k ovládání intenzity vibrací</p>
        
        <div class="status-box" id="status">
            <p>Čekám na připojení Xbox kontroléru...</p>
            <p>Připojte kontrolér přes USB nebo Bluetooth a zmáčkněte libovolné tlačítko.</p>
        </div>
        
        <div class="triggers">
            <div class="trigger">
                <div class="trigger-bar">
                    <div class="trigger-fill" id="ltTrigger"></div>
                </div>
                <div>LEVÁ SPOUŠŤ (LT)</div>
            </div>
            <div class="trigger">
                <div class="trigger-bar">
                    <div class="trigger-fill" id="rtTrigger"></div>
                </div>
                <div>PRAVÁ SPOUŠŤ (RT)</div>
            </div>
        </div>
        
        <div class="vibration-display" id="vibrationDisplay">
            VIBRACE: 0%
        </div>
        
        <div class="buttons">
            <button id="testBtn">Test vibrací (50%)</button>
            <button id="stopBtn">Vypnout vibrace</button>
            <button id="pulseBtn">Krátký impuls</button>
        </div>
        
        <div class="error" id="errorMsg"></div>
        
        <div class="debug-info" id="debugInfo">
            Debug informace se objeví zde...
        </div>
    </div>

    <script>
        // Globální proměnné
        let controller = null;
        let vibrationActive = false;
        let lastVibrationTime = 0;
        
        // Prvky DOM
        const statusElement = document.getElementById('status');
        const vibrationDisplay = document.getElementById('vibrationDisplay');
        const errorElement = document.getElementById('errorMsg');
        const debugElement = document.getElementById('debugInfo');
        
        // Tlačítka
        document.getElementById('testBtn').addEventListener('click', () => {
            applyVibration(0.5, 2000);
        });
        
        document.getElementById('stopBtn').addEventListener('click', () => {
            stopVibration();
        });
        
        document.getElementById('pulseBtn').addEventListener('click', () => {
            pulseVibration(0.75, 300);
        });
        
        // Kontrola podpory Gamepad API
        if (!navigator.getGamepads) {
            showError("Váš prohlížeč nepodporuje Gamepad API. Doporučujeme použít Microsoft Edge nebo Google Chrome.");
            updateStatus("Nepodporovaný prohlížeč");
            return;
        }
        
        // Posluchače událostí gamepadu
        window.addEventListener("gamepadconnected", (e) => {
            controller = e.gamepad;
            updateStatus(`Kontrolér připojen: ${controller.id}`);
            logDebug(`Gamepad připojen: ${JSON.stringify(controller, null, 2)}`);
            
            // Zkontrolujeme podporu vibrací
            checkVibrationSupport();
            
            // Spustíme smyčku aktualizace
            requestAnimationFrame(updateLoop);
        });
        
        window.addEventListener("gamepaddisconnected", (e) => {
            if (controller && controller.index === e.gamepad.index) {
                logDebug(`Gamepad odpojen: ${controller.id}`);
                controller = null;
                stopVibration();
                updateStatus("Kontrolér odpojen. Připojte Xbox kontrolér.");
            }
        });
        
        // Hlavní smyčka aktualizace
        function updateLoop() {
            if (!controller) {
                // Zkusíme najít připojený kontrolér
                const gamepads = navigator.getGamepads();
                for (let i = 0; i < gamepads.length; i++) {
                    if (gamepads[i] && (gamepads[i].id.includes("Xbox") || gamepads[i].mapping === "standard")) {
                        controller = gamepads[i];
                        updateStatus(`Kontrolér připojen: ${controller.id}`);
                        checkVibrationSupport();
                        break;
                    }
                }
            }
            
            if (controller) {
                // Aktualizace stavu spouští
                const ltValue = getTriggerValue(controller, 'left');
                const rtValue = getTriggerValue(controller, 'right');
                
                document.getElementById('ltTrigger').style.height = `${ltValue * 100}%`;
                document.getElementById('rtTrigger').style.height = `${rtValue * 100}%`;
                
                // Výpočet intenzity vibrací
                const vibrationIntensity = Math.max(ltValue, rtValue);
                
                // Aktualizace vibrací pouze pokud je změna větší než 5%
                if (Math.abs(vibrationIntensity - currentVibrationLevel) > 0.05) {
                    currentVibrationLevel = vibrationIntensity;
                    
                    if (vibrationIntensity > 0.05) { // Malý threshold proti chvění
                        applyVibration(vibrationIntensity);
                    } else {
                        stopVibration();
                    }
                }
                
                // Aktualizace displeje
                updateVibrationDisplay(vibrationIntensity);
            }
            
            requestAnimationFrame(updateLoop);
        }
        
        // Proměnná pro sledování aktuální úrovně vibrací
        let currentVibrationLevel = 0;
        
        // Funkce pro získání hodnoty spouště
        function getTriggerValue(gamepad, side) {
            // Standardní mapování (Chrome)
            if (gamepad.buttons && gamepad.buttons.length >= 10) {
                return side === 'left' ? gamepad.buttons[6].value : gamepad.buttons[7].value;
            }
            
            // Alternativní mapování (Firefox)
            if (gamepad.axes && gamepad.axes.length >= 4) {
                const axisValue = side === 'left' ? gamepad.axes[2] : gamepad.axes[5];
                return axisValue !== undefined ? (axisValue + 1) / 2 : 0;
            }
            
            return 0;
        }
        
        // Funkce pro aplikaci vibrací
        function applyVibration(intensity, duration = null) {
            if (!controller || intensity <= 0) {
                stopVibration();
                return;
            }
            
            // Omezení intenzity na rozsah 0-1
            intensity = Math.max(0, Math.min(1, intensity));
            
            try {
                // Moderní API (Chrome 68+)
                if (controller.vibrationActuator) {
                    controller.vibrationActuator.playEffect("dual-rumble", {
                        startDelay: 0,
                        duration: duration || Infinity,
                        weakMagnitude: intensity,
                        strongMagnitude: intensity
                    });
                    vibrationActive = true;
                    lastVibrationTime = Date.now();
                    logDebug(`Vibrace nastaveny na ${Math.round(intensity * 100)}% (moderní API)`);
                }
                // Starší API (experimentální)
                else if (navigator.getGamepads()[controller.index]?.hapticActuators?.[0]) {
                    navigator.getGamepads()[controller.index].hapticActuators[0].pulse(intensity, duration || 1000);
                    vibrationActive = true;
                    lastVibrationTime = Date.now();
                    logDebug(`Vibrace nastaveny na ${Math.round(intensity * 100)}% (starší API)`);
                }
                // Fallback - zkusíme přímý přístup k gamepadu
                else {
                    const gamepad = navigator.getGamepads()[controller.index];
                    if (gamepad && typeof gamepad.pulse === 'function') {
                        gamepad.pulse(intensity, duration || 1000);
                        vibrationActive = true;
                        lastVibrationTime = Date.now();
                        logDebug(`Vibrace nastaveny na ${Math.round(intensity * 100)}% (fallback)`);
                    } else {
                        showError("Tento kontrolér nebo prohlížeč nepodporuje vibrace.");
                        logDebug("Kontrolér nepodporuje vibrace");
                    }
                }
            } catch (e) {
                showError(`Chyba při nastavování vibrací: ${e.message}`);
                logDebug(`Chyba vibrací: ${e.stack}`);
            }
        }
        
        // Funkce pro pulzní vibrace
        function pulseVibration(intensity, duration) {
            applyVibration(intensity, duration);
            setTimeout(() => {
                if (Date.now() - lastVibrationTime >= duration - 50) {
                    stopVibration();
                }
            }, duration);
        }
        
        // Funkce pro zastavení vibrací
        function stopVibration() {
            if (vibrationActive) {
                try {
                    // Moderní API
                    if (controller?.vibrationActuator) {
                        controller.vibrationActuator.playEffect("dual-rumble", {
                            startDelay: 0,
                            duration: 0,
                            weakMagnitude: 0,
                            strongMagnitude: 0
                        });
                    }
                    // Starší API
                    else if (controller && navigator.getGamepads()[controller.index]?.hapticActuators?.[0]) {
                        navigator.getGamepads()[controller.index].hapticActuators[0].pulse(0, 0);
                    }
                    
                    logDebug("Vibrace zastaveny");
                } catch (e) {
                    logDebug(`Chyba při zastavování vibrací: ${e.message}`);
                }
                
                vibrationActive = false;
                currentVibrationLevel = 0;
                updateVibrationDisplay(0);
            }
        }
        
        // Funkce pro aktualizaci zobrazení vibrací
        function updateVibrationDisplay(intensity) {
            const percent = Math.round(intensity * 100);
            vibrationDisplay.textContent = `VIBRACE: ${percent}%`;
            
            // Barevný přechod od zelené po červenou
            const red = Math.round(intensity * 255);
            const green = Math.round((1 - intensity) * 255);
            vibrationDisplay.style.backgroundColor = `rgb(${red}, ${green}, 50)`;
            vibrationDisplay.style.boxShadow = `0 0 ${10 + percent}px rgba(${red}, ${green}, 50, 0.5)`;
        }
        
        // Funkce pro kontrolu podpory vibrací
        function checkVibrationSupport() {
            if (!controller) return false;
            
            const hasSupport = 
                (controller.vibrationActuator) ||
                (navigator.getGamepads()[controller.index]?.hapticActuators?.[0]) ||
                (typeof navigator.getGamepads()[controller.index]?.pulse === 'function');
            
            if (!hasSupport) {
                showError("Váš kontrolér nebo prohlížeč nepodporuje vibrace. Zkuste Microsoft Edge nebo Chrome.");
                logDebug("Kontrolér nepodporuje vibrace");
            }
            
            return hasSupport;
        }
        
        // Pomocné funkce pro UI
        function updateStatus(message) {
            statusElement.innerHTML = `<p><strong>Stav:</strong> ${message}</p>`;
        }
        
        function showError(message) {
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            console.error(message);
        }
        
        function logDebug(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugElement.innerHTML += `[${timestamp}] ${message}\n`;
            debugElement.scrollTop = debugElement.scrollHeight;
        }
        
        // Interakce se stránkou pro povolení API
        document.addEventListener('click', () => {
            logDebug("Uživatel interagoval se stránkou - aktivace Gamepad API");
        }, { once: true });
        
        // Spuštění smyčky po načtení stránky
        window.addEventListener('load', () => {
            updateStatus("Připojte Xbox kontrolér a zmáčkněte libovolné tlačítko");
            logDebug("Stránka načtena - čekám na kontrolér...");
            
            // Některé prohlížeče potřebují aktivaci
            if (navigator.getGamepads().some(g => g)) {
                controller = navigator.getGamepads()[0];
                updateStatus(`Kontrolér připojen: ${controller.id}`);
                checkVibrationSupport();
            }
            
            requestAnimationFrame(updateLoop);
        });
    </script>
</body>
</html>